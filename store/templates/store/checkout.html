{% extends 'core/base.html' %}

{% block title %}Checkout{% endblock %}

{% block content %}
<div class="max-w-2xl mx-auto bg-white shadow-lg rounded-xl p-8 mt-8">
    <h1 class="mb-6 text-3xl font-bold text-center text-gray-800">Checkout</h1>

    <h2 class="text-xl text-gray-600 mb-6 text-center">
        Total Cost: <span class="font-semibold text-amber-600">${{ cart.get_total_cost }}</span>
    </h2>

    <form id="checkout-form" class="space-y-4">
        <div>
            <label for="id_first_name" class="block text-sm font-medium text-gray-700">First Name</label>
            <input type="text" id="id_first_name" name="first_name" 
                class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-amber-500 focus:border-amber-500" required>
        </div>

        <div>
            <label for="id_last_name" class="block text-sm font-medium text-gray-700">Last Name</label>
            <input type="text" id="id_last_name" name="last_name" 
                class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-amber-500 focus:border-amber-500" required>
        </div>

        <div>
            <label for="id_address" class="block text-sm font-medium text-gray-700">Address</label>
            <input type="text" id="id_address" name="address" 
                class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-amber-500 focus:border-amber-500" required>
        </div>

        <div>
            <label for="id_zipcode" class="block text-sm font-medium text-gray-700">Zip Code</label>
            <input type="text" id="id_zipcode" name="zipcode" 
                class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-amber-500 focus:border-amber-500" required>
        </div>

        <div>
            <label for="id_city" class="block text-sm font-medium text-gray-700">City</label>
            <input type="text" id="id_city" name="city" 
                class="mt-1 block w-full px-4 py-2 border border-gray-300 rounded-lg shadow-sm focus:ring-amber-500 focus:border-amber-500" required>
        </div>

        <button class="w-full mt-6 px-6 py-3 bg-amber-500 hover:bg-amber-600 text-white font-semibold text-lg rounded-lg shadow-md transition transform hover:scale-105" onclick="buy(event)">
            Proceed to Payment üí≥
        </button>
    </form>
</div>
{% endblock %}

{% block scripts %}
<script type="application/javascript" src="https://js.stripe.com/v3"></script>
<script>
    function buy(event) {
        event.preventDefault();

        const first_name = document.getElementById('id_first_name').value.trim();
        const last_name  = document.getElementById('id_last_name').value.trim();
        const address    = document.getElementById('id_address').value.trim();
        const zipcode    = document.getElementById('id_zipcode').value.trim();
        const city       = document.getElementById('id_city').value.trim();

        // Check if any field is empty
        if (!first_name || !last_name || !address || !zipcode || !city) {
            alert("‚ö†Ô∏è Please fill out all required fields before proceeding.");
            return false;
        }

        let data = {
            'first_name': first_name,
            'last_name': last_name,
            'address': address,
            'zipcode': zipcode,
            'city': city,
        };

        let stripe = Stripe('{{ pub_key }}');

        fetch('/cart/checkout/', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': '{{ csrf_token }}'
            },
            credentials: 'same-origin',
            body: JSON.stringify(data)
        })
        .then(function(response) {
            return response.json();
        })
        .then(function(session) {
            return stripe.redirectToCheckout({ sessionId: session.session.id });
        })
        .then(function(result) {
            if (result.error) {
                alert(result.error.message);
            }
        })
        .catch(function(error) {
            alert(error);
        });

        return false;
    }
</script>
{% endblock %}